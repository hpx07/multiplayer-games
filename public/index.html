<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>System Process Manager v4.0</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overscroll-behavior:none;}
body{font-family:'Consolas','Courier New',monospace;background:#0C0C0C;color:#CCCCCC;font-size:13px;touch-action:manipulation;}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:#0C0C0C;}
::-webkit-scrollbar-thumb{background:#1E1E1E;}

/* LOGIN */
#loginScreen{width:100%;height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;}
.loginBox{border:1px solid #1E1E1E;padding:28px 24px;background:#0C0C0C;width:100%;max-width:400px;}
.loginLogo{color:#00FF00;font-size:11px;margin-bottom:22px;line-height:1.8;}
.loginBox label{color:#888;font-size:11px;display:block;margin-bottom:6px;}
.loginBox input{width:100%;padding:12px 10px;background:#0C0C0C;border:1px solid #1E1E1E;color:#00FF00;font-family:'Consolas',monospace;font-size:16px;margin-bottom:10px;border-radius:0;-webkit-appearance:none;}
.loginBox input:focus{outline:none;border-color:#00FF00;}
.errMsg{color:#FF5555;font-size:11px;min-height:16px;margin-bottom:10px;}
.loginBtn{width:100%;padding:14px;background:#1E1E1E;border:1px solid #00FF00;color:#00FF00;cursor:pointer;font-family:'Consolas',monospace;font-size:13px;letter-spacing:1px;border-radius:0;}
.loginBtn:active{background:#00FF00;color:#0C0C0C;}

/* APP SHELL */
#app{display:none;height:100vh;height:100dvh;flex-direction:column;overflow:hidden;}
#topbar{background:#0C0C0C;border-bottom:1px solid #1E1E1E;padding:0 12px;display:flex;align-items:center;justify-content:space-between;font-size:11px;height:40px;flex-shrink:0;}
#topbar .tl{color:#00FF00;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60%;}
#topbar .tr{color:#555;display:flex;gap:14px;flex-shrink:0;}
#topbar .tr span{cursor:pointer;padding:6px 2px;font-size:12px;}
#topbar .tr span:active{color:#00FF00;}

/* BOTTOM NAV */
#bottomNav{display:none;background:#0C0C0C;border-top:1px solid #1E1E1E;flex-shrink:0;}
.bnInner{display:flex;}
.bnBtn{flex:1;padding:9px 4px 8px;text-align:center;cursor:pointer;font-family:'Consolas',monospace;font-size:9px;color:#444;border:none;background:transparent;border-right:1px solid #1E1E1E;letter-spacing:0.5px;}
.bnBtn:last-child{border-right:none;}
.bnBtn:active,.bnBtn.active{color:#00FF00;background:#040f04;}
.bnIcon{font-size:18px;display:block;margin-bottom:2px;}

/* LAYOUT */
#mainLayout{display:flex;flex:1;overflow:hidden;}
#sidebar{width:200px;background:#0C0C0C;border-right:1px solid #1E1E1E;padding:10px;display:flex;flex-direction:column;overflow-y:auto;gap:12px;flex-shrink:0;}
.sideTitle{color:#444;font-size:10px;letter-spacing:1px;border-bottom:1px solid #111;padding-bottom:3px;margin-bottom:5px;}
.playerItem{color:#00FF00;font-size:11px;padding:2px 0;}
.playerItem.busy{color:#FFD700;}
.lbItem{display:flex;justify-content:space-between;font-size:11px;padding:2px 0;}
.lbItem .pts{color:#00FF00;}
.sideBtn{width:100%;padding:7px 8px;background:#0C0C0C;border:1px solid #1E1E1E;color:#555;cursor:pointer;font-family:'Consolas',monospace;font-size:11px;text-align:left;margin-top:3px;}
.sideBtn:hover{border-color:#00FF00;color:#00FF00;}
#content{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}

/* GAME SELECT */
#gameSelect{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;padding:16px;overflow-y:auto;}
.gsTitle{color:#00FF00;font-size:12px;letter-spacing:3px;}
.gsCards{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;width:100%;}
.gsCard{flex:1;min-width:130px;max-width:180px;border:1px solid #1E1E1E;padding:20px 12px;cursor:pointer;text-align:center;background:#0C0C0C;}
.gsCard:active{border-color:#00FF00;background:#040f04;}
.gsIcon{font-size:28px;margin-bottom:8px;}
.gsName{color:#00FF00;font-size:12px;letter-spacing:1px;margin-bottom:4px;}
.gsDesc{color:#444;font-size:10px;line-height:1.5;}

/* PANELS */
.panel{flex:1;display:none;flex-direction:column;overflow:hidden;}
.panel.active{display:flex;}
.panelHead{padding:8px 12px;border-bottom:1px solid #1E1E1E;display:flex;align-items:center;justify-content:space-between;font-size:11px;min-height:36px;flex-shrink:0;}
.panelHead .ph{color:#00FF00;font-size:11px;}
.backBtn{padding:8px 12px;background:#0C0C0C;border:1px solid #1E1E1E;color:#555;cursor:pointer;font-family:'Consolas',monospace;font-size:11px;min-height:36px;border-radius:0;}
.backBtn:active{border-color:#00FF00;color:#00FF00;}

/* BUTTONS */
.btn{padding:12px 20px;background:#0C0C0C;border:1px solid #00FF00;color:#00FF00;cursor:pointer;font-family:'Consolas',monospace;font-size:12px;min-height:44px;border-radius:0;-webkit-appearance:none;}
.btn:active{background:#00FF00;color:#0C0C0C;}
.btn:disabled{border-color:#222;color:#222;cursor:not-allowed;background:#0C0C0C;}
.btn.danger{border-color:#FF5555;color:#FF5555;}
.btn.danger:active{background:#FF5555;color:#0C0C0C;}

/* TTT */
#tttLobby{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:18px;padding:16px;}
#tttLobby .lmsg{color:#444;font-size:12px;text-align:center;}
.tttBtns{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}
#tttGame{flex:1;display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px;padding:12px;overflow:auto;}
#tttGame.active{display:flex;}
.tttInfo{text-align:center;font-size:11px;color:#CCCCCC;line-height:1.8;}
.tttInfo .vs{color:#FFD700;margin:0 6px;}
.tttTurn{font-size:12px;letter-spacing:1px;color:#00FF00;text-align:center;}
.tttBoard{display:grid;grid-template-columns:repeat(3,1fr);gap:3px;background:#1E1E1E;padding:3px;width:min(285px,82vw);height:min(285px,82vw);}
.tttCell{background:#0C0C0C;display:flex;align-items:center;justify-content:center;font-size:min(50px,12vw);cursor:pointer;color:#00FF00;font-weight:bold;border:1px solid #111;min-height:44px;}
.tttCell:active:not(.filled){background:#040f04;}
.tttCell.filled{cursor:not-allowed;}
.tttCell.O{color:#FF5555;}

/* BINGO */
#bingoLobby{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;text-align:center;padding:16px;}
#bingoLobby h3{color:#00FF00;font-size:12px;letter-spacing:2px;}
#bingoLobby p{color:#444;font-size:11px;line-height:1.6;}
#bingoGame{flex:1;display:none;flex-direction:column;overflow:hidden;}
#bingoGame.active{display:flex;}
.bingoTabs{display:none;border-bottom:1px solid #1E1E1E;flex-shrink:0;}
.bingoTabs .tab{flex:1;padding:11px;text-align:center;cursor:pointer;font-family:'Consolas',monospace;font-size:11px;color:#444;border:none;background:#0C0C0C;border-bottom:2px solid transparent;}
.bingoTabs .tab.active{color:#00FF00;border-bottom-color:#00FF00;}
#bingoContent{flex:1;display:flex;overflow:hidden;}
#bingoLeft{width:min(295px,46%);padding:10px;border-right:1px solid #1E1E1E;display:flex;flex-direction:column;gap:8px;overflow-y:auto;flex-shrink:0;}
.bingoHdr{display:grid;grid-template-columns:repeat(5,1fr);gap:2px;margin-bottom:2px;}
.bingoHdrCell{background:#040f04;color:#00FF00;text-align:center;padding:6px 0;font-size:11px;font-weight:bold;letter-spacing:1px;}
.bingoCard{display:grid;grid-template-columns:repeat(5,1fr);gap:2px;background:#1E1E1E;padding:2px;}
.bCell{background:#0C0C0C;color:#CCCCCC;text-align:center;padding:min(9px,2vw) 2px;font-size:min(13px,3.2vw);cursor:pointer;border:1px solid #111;line-height:1;min-height:38px;display:flex;align-items:center;justify-content:center;}
.bCell:active:not(.marked){background:#040f04;}
.bCell.marked{background:#003300;color:#00FF00;border-color:#00FF00;}
.bCell.free{background:#001a00;color:#00FF00;font-size:9px;border-color:#00FF00;}
.bCell.called{color:#FFD700;}
#bingoRight{flex:1;padding:10px;display:flex;flex-direction:column;gap:8px;overflow-y:auto;min-width:0;}
.callDisplay{text-align:center;padding:12px;border:1px solid #1E1E1E;background:#040404;flex-shrink:0;}
.callDisplay .clbl{color:#444;font-size:10px;margin-bottom:4px;}
.callDisplay .cltr{color:#FFD700;font-size:15px;}
.callDisplay .cnum{font-size:min(52px,13vw);color:#00FF00;font-weight:bold;line-height:1;}
.calledLog{border:1px solid #1E1E1E;padding:8px;max-height:120px;overflow-y:auto;}
.calledLogTitle{color:#444;font-size:10px;margin-bottom:5px;}
.calledNums{display:flex;flex-wrap:wrap;gap:3px;}
.cnum-item{padding:2px 5px;background:#1E1E1E;color:#888;font-size:10px;}
.cnum-item.recent{background:#003300;color:#00FF00;border:1px solid #00FF00;}
.hostCtrl{border:1px solid #1E1E1E;padding:10px;flex-shrink:0;}
.hostCtrlTitle{color:#444;font-size:10px;margin-bottom:8px;}
.hostBtns{display:flex;flex-wrap:wrap;gap:6px;align-items:center;}
.hostBtn{padding:10px 12px;background:#0C0C0C;border:1px solid #00FF00;color:#00FF00;cursor:pointer;font-family:'Consolas',monospace;font-size:11px;min-height:42px;border-radius:0;}
.hostBtn:active{background:#00FF00;color:#0C0C0C;}
.hostBtn:disabled{border-color:#222;color:#222;}
.hostBtn.danger{border-color:#FF5555;color:#FF5555;}
.hostBtn.danger:active{background:#FF5555;color:#0C0C0C;}
.autoSel{background:#0C0C0C;border:1px solid #1E1E1E;color:#00FF00;padding:9px 8px;font-family:'Consolas',monospace;font-size:11px;min-height:42px;border-radius:0;}
.winnersBox{border:1px solid #FFD700;padding:8px;flex-shrink:0;}
.winnersTitle{color:#FFD700;font-size:10px;margin-bottom:5px;}
.winnerItem{color:#FFD700;font-size:12px;padding:2px 0;}

/* DOTS & BOXES */
#dabLobby{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;text-align:center;padding:16px;overflow-y:auto;}
#dabLobby h3{color:#00FF00;font-size:12px;letter-spacing:2px;}
#dabLobby p{color:#444;font-size:11px;line-height:1.7;}
.dabSetup{border:1px solid #1E1E1E;padding:16px;text-align:left;width:100%;max-width:320px;}
.dabSetup label{color:#888;font-size:11px;display:block;margin-bottom:5px;margin-top:10px;}
.dabSetup label:first-child{margin-top:0;}
.dabSel{width:100%;background:#0C0C0C;border:1px solid #1E1E1E;color:#00FF00;padding:10px;font-family:'Consolas',monospace;font-size:14px;border-radius:0;-webkit-appearance:none;min-height:44px;background-image:none;}
.dabSel:focus{outline:none;border-color:#00FF00;}
.dabQueueInfo{color:#444;font-size:11px;margin-top:6px;min-height:16px;}
.dabLobbyBtns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}
#dabGame{flex:1;display:none;flex-direction:column;overflow:hidden;}
#dabGame.active{display:flex;}
#dabTurnBar{padding:8px 12px;border-bottom:1px solid #1E1E1E;font-size:11px;text-align:center;color:#00FF00;flex-shrink:0;min-height:34px;display:flex;align-items:center;justify-content:center;}
#dabScoreBar{border-bottom:1px solid #1E1E1E;padding:8px 12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center;flex-shrink:0;background:#0C0C0C;}
.dabScoreItem{display:flex;align-items:center;gap:5px;font-size:11px;}
.dabColorDot{width:8px;height:8px;display:inline-block;border-radius:50%;}
#dabGameBody{flex:1;overflow:hidden;display:flex;}
#dabCanvas{flex:1;display:flex;align-items:center;justify-content:center;background:#0C0C0C;overflow:auto;padding:10px;-webkit-overflow-scrolling:touch;}
.dabGrid{position:relative;touch-action:none;}
.dabDotEl{position:absolute;background:#888;border-radius:50%;transform:translate(-50%,-50%);z-index:3;}
.dabLineH,.dabLineV{position:absolute;cursor:pointer;z-index:2;display:flex;align-items:center;justify-content:center;}
.dabLineH{transform:translateY(-50%);}
.dabLineV{transform:translateX(-50%);}
.dabLineH::after{content:'';position:absolute;width:100%;height:28px;top:50%;transform:translateY(-50%);}
.dabLineV::after{content:'';position:absolute;height:100%;width:28px;left:50%;transform:translateX(-50%);}
.dabLineInner{background:#1E1E1E;transition:background 0.15s;border-radius:2px;}
.dabLineH .dabLineInner{width:100%;height:5px;}
.dabLineV .dabLineInner{height:100%;width:5px;}
.dabLineH:active .dabLineInner,.dabLineV:active .dabLineInner{background:rgba(0,255,0,0.5);}
.dabLineH.drawn,.dabLineV.drawn{pointer-events:none;}
.dabBox{position:absolute;display:flex;align-items:center;justify-content:center;font-weight:bold;z-index:1;border-radius:2px;}

/* RESULT */
#resultModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(12,12,12,0.97);display:none;align-items:center;justify-content:center;z-index:9999;padding:16px;}
#resultModal.show{display:flex;}
.resultBox{border:2px solid #00FF00;padding:28px 24px;text-align:center;background:#0C0C0C;width:100%;max-width:340px;}
.resultBox.loss{border-color:#FF5555;}
.resultBox.draw{border-color:#FFD700;}
.resultTitle{font-size:24px;margin-bottom:8px;letter-spacing:2px;color:#00FF00;}
.resultBox.loss .resultTitle{color:#FF5555;}
.resultBox.draw .resultTitle{color:#FFD700;}
.resultSub{color:#444;font-size:11px;margin-bottom:14px;}
.resultScores{margin-bottom:16px;font-size:12px;}
.resultScoreRow{padding:4px 0;display:flex;justify-content:space-between;gap:20px;}
.rBtns{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
.rBtn{padding:12px 20px;background:#0C0C0C;border:1px solid #00FF00;color:#00FF00;cursor:pointer;font-family:'Consolas',monospace;font-size:12px;min-height:44px;border-radius:0;}
.rBtn:active{background:#00FF00;color:#0C0C0C;}

/* TOAST */
#toast{position:fixed;top:48px;left:50%;transform:translateX(-50%);padding:10px 16px;background:#1E1E1E;border:1px solid #00FF00;color:#00FF00;font-size:11px;z-index:9998;display:none;white-space:nowrap;max-width:90vw;overflow:hidden;text-overflow:ellipsis;}
#toast.show{display:block;}
#toast.err{border-color:#FF5555;color:#FF5555;}
#toast.warn{border-color:#FFD700;color:#FFD700;}

/* CHAT */
#chatWrap{position:fixed;bottom:0;right:0;width:min(280px,100%);background:#0C0C0C;border:1px solid #1E1E1E;display:none;flex-direction:column;z-index:200;max-height:60vh;}
#chatWrap.open{display:flex;}
#chatHead{padding:10px 12px;background:#111;color:#00FF00;font-size:11px;cursor:pointer;display:flex;justify-content:space-between;flex-shrink:0;}
#chatMsgs{flex:1;overflow-y:auto;padding:8px;font-size:11px;min-height:120px;}
.chatMsg{margin-bottom:5px;line-height:1.5;word-break:break-word;}
.chatMsg .cu{color:#00FF00;}
#chatFoot{display:flex;border-top:1px solid #1E1E1E;flex-shrink:0;}
#chatFoot input{flex:1;padding:10px;background:#0C0C0C;border:none;color:#00FF00;font-family:'Consolas',monospace;font-size:14px;border-radius:0;}
#chatFoot input:focus{outline:none;}
#chatFoot button{padding:10px 14px;background:#111;border:none;color:#00FF00;cursor:pointer;font-size:12px;min-width:50px;}
#chatFoot button:active{background:#00FF00;color:#0C0C0C;}

/* DRAWER */
#drawer{position:fixed;top:0;left:-100%;width:80%;max-width:280px;height:100%;background:#0C0C0C;border-right:1px solid #1E1E1E;z-index:500;display:flex;flex-direction:column;padding:12px;overflow-y:auto;gap:14px;transition:left 0.25s ease;}
#drawer.open{left:0;}
#drawerOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:499;display:none;}
#drawerOverlay.show{display:block;}
#drawerClose{padding:8px;color:#00FF00;font-family:'Consolas',monospace;font-size:11px;cursor:pointer;margin-bottom:8px;}

/* RESPONSIVE */
@media(max-width:700px){
  #sidebar{display:none !important;}
  #bottomNav{display:block;}
  .tttBtns{flex-direction:column;width:100%;max-width:260px;}
  .tttBtns .btn{width:100%;}
  #bingoContent{flex-direction:column;}
  #bingoLeft{width:100%;border-right:none;border-bottom:1px solid #1E1E1E;max-height:52%;}
  .bingoTabs{display:flex;}
  .bCell{min-height:40px;}
  .dabSetup{max-width:100%;}
  .gsCard{min-width:100px;}
}
@media(min-width:701px){
  #drawer{display:none !important;}
  #drawerOverlay{display:none !important;}
}
@media(max-width:380px){
  .gsCards{flex-direction:column;align-items:center;}
  .gsCard{width:100%;max-width:100%;}
}
</style>
</head>
<body>

<div id="loginScreen">
  <div class="loginBox">
    <div class="loginLogo">SYSTEM PROCESS MANAGER v4.0<br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br><span style="color:#333">LAN Mode | 3 Games | Mobile Ready</span></div>
    <label>USERNAME</label>
    <input type="text" id="unInput" placeholder="Enter identifier..." maxlength="15" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <div class="errMsg" id="loginErr"></div>
    <button class="loginBtn" onclick="doLogin()">â–¶ INITIALIZE SESSION</button>
  </div>
</div>

<div id="app">
  <div id="topbar">
    <div class="tl">SPM v4.0 &nbsp;|&nbsp; <span id="tbUser"></span></div>
    <div class="tr">
      <span onclick="openDrawer()">â˜°</span>
      <span onclick="toggleChat()">CHAT</span>
    </div>
  </div>

  <div id="mainLayout">
    <div id="sidebar">
      <div><div class="sideTitle">ONLINE (<span id="onlineCount">0</span>)</div><div id="sidePlayerList"></div></div>
      <div><div class="sideTitle">TTT RANKS</div><div id="sideTTTLb"></div></div>
      <div><div class="sideTitle">BINGO RANKS</div><div id="sideBingoLb"></div></div>
      <div><div class="sideTitle">D&B RANKS</div><div id="sideDABLb"></div></div>
      <div style="margin-top:auto;">
        <button class="sideBtn" onclick="showGameSelect()">â—€ GAME MENU</button>
        <button class="sideBtn" onclick="toggleChat()">â–  CHAT</button>
      </div>
    </div>

    <div id="content">
      <!-- GAME SELECT -->
      <div id="gameSelect" style="flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;padding:16px;overflow-y:auto;">
        <div class="gsTitle">SELECT MODULE</div>
        <div class="gsCards">
          <div class="gsCard" onclick="loadTTT()"><div class="gsIcon">âœ•â—‹</div><div class="gsName">TIC-TAC-TOE</div><div class="gsDesc">1v1 battles.<br>Quick match or tournament.</div></div>
          <div class="gsCard" onclick="loadBingo()"><div class="gsIcon">ðŸ…±</div><div class="gsName">BINGO</div><div class="gsDesc">Everyone plays.<br>Host calls numbers.</div></div>
          <div class="gsCard" onclick="loadDAB()"><div class="gsIcon">âŠž</div><div class="gsName">DOTS &amp; BOXES</div><div class="gsDesc">Draw lines, claim boxes.<br>2â€“4 players.</div></div>
        </div>
      </div>

      <!-- TTT -->
      <div id="tttPanel" class="panel">
        <div class="panelHead"><div class="ph">TIC-TAC-TOE</div><button class="backBtn" onclick="showGameSelect()">â—€ BACK</button></div>
        <div id="tttLobby">
          <div class="lmsg" id="tttMsg">Ready â€” pick a mode</div>
          <div class="tttBtns">
            <button class="btn" id="tttQMBtn" onclick="ttt_findMatch()">QUICK MATCH</button>
            <button class="btn" onclick="ttt_startTournament()">TOURNAMENT</button>
          </div>
        </div>
        <div id="tttGame">
          <div class="tttInfo"><span id="tttP1"></span><span class="vs">VS</span><span id="tttP2"></span><br>YOU: <span id="tttSym" style="color:#00FF00;font-weight:bold;"></span></div>
          <div class="tttTurn" id="tttTurn">...</div>
          <div class="tttBoard">
            <div class="tttCell" data-i="0" onclick="ttt_move(0)"></div><div class="tttCell" data-i="1" onclick="ttt_move(1)"></div><div class="tttCell" data-i="2" onclick="ttt_move(2)"></div>
            <div class="tttCell" data-i="3" onclick="ttt_move(3)"></div><div class="tttCell" data-i="4" onclick="ttt_move(4)"></div><div class="tttCell" data-i="5" onclick="ttt_move(5)"></div>
            <div class="tttCell" data-i="6" onclick="ttt_move(6)"></div><div class="tttCell" data-i="7" onclick="ttt_move(7)"></div><div class="tttCell" data-i="8" onclick="ttt_move(8)"></div>
          </div>
          <button class="backBtn" onclick="ttt_backToLobby()">â—€ LOBBY</button>
        </div>
      </div>

      <!-- BINGO -->
      <div id="bingoPanel" class="panel">
        <div class="panelHead">
          <div class="ph">BINGO &nbsp;|&nbsp; <span id="bingoStatus" style="color:#444;">LOBBY</span></div>
          <div style="display:flex;gap:8px;align-items:center;"><span id="bingoRoomInfo" style="color:#444;font-size:10px;"></span><button class="backBtn" onclick="bingo_leave()">â—€ LEAVE</button></div>
        </div>
        <div id="bingoLobby"><h3>BINGO ROOM</h3><p>Join to get your card.<br>First player becomes HOST.</p><button class="btn" onclick="bingo_join()">JOIN ROOM</button></div>
        <div id="bingoGame">
          <div class="bingoTabs" id="bingoTabs">
            <button class="tab active" onclick="showBingoTab('card')">MY CARD</button>
            <button class="tab" onclick="showBingoTab('control')">NUMBERS</button>
          </div>
          <div id="bingoContent">
            <div id="bingoLeft">
              <div style="color:#00FF00;font-size:10px;letter-spacing:1px;">YOUR CARD</div>
              <div class="bingoHdr"><div class="bingoHdrCell">B</div><div class="bingoHdrCell">I</div><div class="bingoHdrCell">N</div><div class="bingoHdrCell">G</div><div class="bingoHdrCell">O</div></div>
              <div class="bingoCard" id="bingoCard"></div>
              <button class="btn" id="bingoClaimBtn" onclick="bingo_claim()" disabled style="width:100%;margin-top:6px;">ðŸŽ‰ CLAIM BINGO!</button>
            </div>
            <div id="bingoRight">
              <div class="callDisplay"><div class="clbl">CURRENT NUMBER</div><div class="cltr" id="bCallLetter">-</div><div class="cnum" id="bCallNum">--</div></div>
              <div class="hostCtrl" id="hostCtrl" style="display:none;">
                <div class="hostCtrlTitle">HOST CONTROLS</div>
                <div class="hostBtns">
                  <button class="hostBtn" id="bStartBtn" onclick="bingo_startGame()">â–¶ START</button>
                  <button class="hostBtn" id="bCallBtn" onclick="bingo_callNumber()" disabled>CALL NUMBER</button>
                  <select class="autoSel" id="autoSel" onchange="bingo_setAutoCall(this.value)"><option value="0">Manual</option><option value="5">Auto 5s</option><option value="10">Auto 10s</option><option value="15">Auto 15s</option></select>
                  <button class="hostBtn danger" onclick="bingo_resetGame()">â†º RESET</button>
                </div>
              </div>
              <div class="winnersBox" id="bWinnersBox" style="display:none;"><div class="winnersTitle">WINNERS</div><div id="bWinnersList"></div></div>
              <div class="calledLog"><div class="calledLogTitle">CALLED (<span id="bCalledCount">0</span>/75)</div><div class="calledNums" id="bCalledNums"></div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- DOTS & BOXES -->
      <div id="dabPanel" class="panel">
        <div class="panelHead"><div class="ph">DOTS &amp; BOXES &nbsp;|&nbsp; <span id="dabStatus" style="color:#444;">LOBBY</span></div><button class="backBtn" onclick="dab_back()">â—€ BACK</button></div>
        <div id="dabLobby">
          <h3>DOTS &amp; BOXES</h3>
          <p>Draw lines between dots.<br>Complete a box = score + extra turn!<br>Most boxes wins!</p>
          <div class="dabSetup">
            <label>GRID SIZE</label>
            <select class="dabSel" id="dabGridSize"><option value="3">3Ã—3 Quick (9 boxes)</option><option value="4" selected>4Ã—4 Standard (16 boxes)</option><option value="5">5Ã—5 Large (25 boxes)</option></select>
            <label>MAX PLAYERS</label>
            <select class="dabSel" id="dabMaxPlayers"><option value="2">2 Players</option><option value="3">3 Players</option><option value="4">4 Players</option></select>
            <div class="dabQueueInfo" id="dabQueueInfo"></div>
          </div>
          <div class="dabLobbyBtns">
            <button class="btn" id="dabJoinBtn" onclick="dab_joinQueue()">JOIN QUEUE</button>
            <button class="btn" id="dabStartBtn" onclick="dab_startGame()" style="display:none;">START GAME</button>
            <button class="btn danger" id="dabCancelBtn" onclick="dab_cancelQueue()" style="display:none;">CANCEL</button>
          </div>
        </div>
        <div id="dabGame">
          <div id="dabTurnBar">Waiting...</div>
          <div id="dabScoreBar"></div>
          <div id="dabGameBody"><div id="dabCanvas"><div id="dabGrid" class="dabGrid"></div></div></div>
        </div>
      </div>
    </div>
  </div>

  <div id="bottomNav">
    <div class="bnInner">
      <button class="bnBtn" onclick="showGameSelect()"><span class="bnIcon">ðŸŽ®</span>GAMES</button>
      <button class="bnBtn" onclick="loadTTT()"><span class="bnIcon">âœ•â—‹</span>TTT</button>
      <button class="bnBtn" onclick="loadBingo()"><span class="bnIcon">ðŸ…±</span>BINGO</button>
      <button class="bnBtn" onclick="loadDAB()"><span class="bnIcon">âŠž</span>D&amp;B</button>
      <button class="bnBtn" onclick="toggleChat()"><span class="bnIcon">ðŸ’¬</span>CHAT</button>
    </div>
  </div>
</div>

<div id="drawerOverlay" onclick="closeDrawer()"></div>
<div id="drawer">
  <div id="drawerClose" onclick="closeDrawer()">âœ• CLOSE</div>
  <div><div class="sideTitle">ONLINE (<span id="dOnlineCount">0</span>)</div><div id="dPlayerList"></div></div>
  <div><div class="sideTitle">TTT RANKS</div><div id="dTTTLb"></div></div>
  <div><div class="sideTitle">BINGO RANKS</div><div id="dBingoLb"></div></div>
  <div><div class="sideTitle">D&B RANKS</div><div id="dDABLb"></div></div>
</div>

<div id="resultModal">
  <div class="resultBox" id="resultBox">
    <div class="resultTitle" id="resultTitle">YOU WIN!</div>
    <div class="resultSub" id="resultSub"></div>
    <div class="resultScores" id="resultScores"></div>
    <div class="rBtns"><button class="rBtn" id="rBackBtn" onclick="closeResult()">BACK TO LOBBY</button><button class="rBtn" id="rematchBtn" onclick="requestRematch()">REMATCH</button></div>
  </div>
</div>

<div id="toast"></div>

<div id="chatWrap">
  <div id="chatHead" onclick="toggleChat()">NETWORK CHAT <span>â–¼</span></div>
  <div id="chatMsgs"></div>
  <div id="chatFoot">
    <input type="text" id="chatIn" placeholder="Message..." maxlength="120" autocorrect="off" autocapitalize="off">
    <button onclick="sendChat()">â–¶</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
let socket,myUsername;
let tttGameId=null,tttSym=null,tttMyTurn=false;
let myCard=[],myMarked=[],amHost=false,bingoActive=false;
let dabRoomId=null,myPlayerIndex=-1,myColor='#00FF00';
let dabGridSize=4,dabCurrentState=null,inDabQueue=false;

function getDabCellSize(){const vw=window.innerWidth;if(vw<=380)return 50;if(vw<=500)return 56;if(vw<=700)return 62;return 68;}

// LOGIN
function doLogin(){
  const un=document.getElementById('unInput').value.trim();
  if(!un)return setLoginErr('Username required');
  socket=io();
  socket.on('joined',d=>{myUsername=d.username;document.getElementById('loginScreen').style.display='none';document.getElementById('app').style.display='flex';document.getElementById('tbUser').textContent=myUsername;setupListeners();});
  socket.on('joinError',msg=>setLoginErr(msg));
  socket.emit('join',un);
}
function setLoginErr(m){document.getElementById('loginErr').textContent=m;}
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('unInput').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
  document.getElementById('chatIn').addEventListener('keydown',e=>{if(e.key==='Enter')sendChat();});
});

function setupListeners(){
  socket.on('lobbyUpdate',d=>updateSidebar(d));
  socket.on('chatMessage',d=>appendChat(d.username,d.message));
  socket.on('error',msg=>toast(msg,'err'));
  // TTT
  socket.on('ttt_waiting',msg=>{document.getElementById('tttMsg').textContent=msg;document.getElementById('tttQMBtn').textContent='CANCEL';document.getElementById('tttQMBtn').onclick=ttt_cancel;});
  socket.on('ttt_searchCancelled',()=>{document.getElementById('tttMsg').textContent='Ready â€” pick a mode';document.getElementById('tttQMBtn').textContent='QUICK MATCH';document.getElementById('tttQMBtn').onclick=ttt_findMatch;});
  socket.on('ttt_gameStart',d=>{tttGameId=d.gameId;tttSym=d.symbol;tttMyTurn=d.yourTurn;document.getElementById('tttSym').textContent=tttSym;ttt_showBoard();ttt_resetCells();toast('Game started! You are '+tttSym);});
  socket.on('ttt_gameUpdate',d=>ttt_updateBoard(d));
  socket.on('ttt_gameEnd',d=>setTimeout(()=>showTTTResult(d.result,d.gameId),400));
  socket.on('ttt_opponentDisconnected',()=>{toast('Opponent left','warn');ttt_backToLobby();});
  socket.on('ttt_rematchRequest',reqId=>{if(confirm('Rematch? Accept?'))socket.emit('ttt_acceptRematch',reqId);});
  socket.on('ttt_tournamentStart',d=>toast('Tournament! '+d.bracket.length+' matches!'));
  // BINGO
  socket.on('bingo_youAreHost',()=>{amHost=true;document.getElementById('hostCtrl').style.display='block';toast('You are HOST!','warn');});
  socket.on('bingo_cardAssigned',d=>{myCard=d.card;myMarked=d.markedNumbers||Array(25).fill(null).map((_,i)=>i===12?true:null);bingoActive=d.gameActive;amHost=d.isHost;showBingoGame();renderCard();if(amHost)document.getElementById('hostCtrl').style.display='block';if(d.calledNumbers&&d.calledNumbers.length>0){d.calledNumbers.forEach((n,i)=>renderCalledNum(n,i===d.calledNumbers.length-1));document.getElementById('bCalledCount').textContent=d.calledNumbers.length;}if(bingoActive){document.getElementById('bStartBtn').disabled=true;document.getElementById('bCallBtn').disabled=false;document.getElementById('bingoClaimBtn').disabled=false;document.getElementById('bingoStatus').textContent='ACTIVE';}});
  socket.on('bingo_gameStarted',()=>{bingoActive=true;myMarked=Array(25).fill(null).map((_,i)=>i===12?true:null);renderCard();clearCalledNums();document.getElementById('bCallLetter').textContent='-';document.getElementById('bCallNum').textContent='--';document.getElementById('bStartBtn').disabled=true;document.getElementById('bCallBtn').disabled=false;document.getElementById('bingoClaimBtn').disabled=false;document.getElementById('bingoStatus').textContent='ACTIVE';document.getElementById('bWinnersBox').style.display='none';document.getElementById('bWinnersList').innerHTML='';toast('BINGO started!');if(window.innerWidth<=700)showBingoTab('control');});
  socket.on('bingo_numberCalled',d=>{renderCalledNum(d.number,true);document.getElementById('bCalledCount').textContent=d.calledNumbers.length;const ltr=bingoLetter(d.number);document.getElementById('bCallLetter').textContent=ltr;document.getElementById('bCallNum').textContent=d.number;const idx=myCard.indexOf(d.number);if(idx!==-1&&!myMarked[idx]){myMarked[idx]=true;socket.emit('bingo_markNumber',d.number);renderCard();toast('âœ“ '+ltr+d.number+' on your card!');if(window.innerWidth<=700)showBingoTab('card');}});
  socket.on('bingo_markConfirmed',d=>{myMarked[d.index]=true;renderCard();});
  socket.on('bingo_winner',d=>{document.getElementById('bWinnersBox').style.display='block';const wl=document.getElementById('bWinnersList');const pos=['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'][d.position-1]||d.position+'.';wl.innerHTML+=`<div class="winnerItem">${pos} ${d.username}</div>`;toast(d.username===myUsername?'ðŸŽ‰ YOU GOT BINGO!':d.username+' got BINGO!','warn');});
  socket.on('bingo_validClaim',()=>toast('âœ“ BINGO confirmed!','warn'));
  socket.on('bingo_invalidClaim',m=>toast(m,'err'));
  socket.on('bingo_gameEnded',d=>{bingoActive=false;document.getElementById('bingoStatus').textContent='OVER';document.getElementById('bCallBtn').disabled=true;document.getElementById('bingoClaimBtn').disabled=true;if(amHost)document.getElementById('bStartBtn').disabled=false;toast('Game over! Winners: '+d.winners.join(', '));});
  socket.on('bingo_gameReset',()=>{bingoActive=false;myMarked=Array(25).fill(null).map((_,i)=>i===12?true:null);clearCalledNums();renderCard();document.getElementById('bCallLetter').textContent='-';document.getElementById('bCallNum').textContent='--';document.getElementById('bStartBtn').disabled=false;document.getElementById('bCallBtn').disabled=true;document.getElementById('bingoClaimBtn').disabled=true;document.getElementById('bingoStatus').textContent='LOBBY';document.getElementById('bWinnersBox').style.display='none';document.getElementById('autoSel').value='0';toast('Game reset!');socket.emit('bingo_joinRoom');});
  socket.on('bingo_roomUpdate',d=>{document.getElementById('bingoRoomInfo').textContent=d.playerCount+' player(s)';if(amHost&&!d.gameActive)document.getElementById('bStartBtn').disabled=d.playerCount<2;});
  socket.on('bingo_autoCallUpdated',v=>toast(v>0?'Auto-call every '+v+'s':'Manual mode'));
  // DAB
  socket.on('dab_queued',d=>{inDabQueue=true;document.getElementById('dabQueueInfo').textContent='In queue ('+d.position+' waiting)...';document.getElementById('dabJoinBtn').style.display='none';document.getElementById('dabStartBtn').style.display='inline-block';document.getElementById('dabCancelBtn').style.display='inline-block';toast('In queue! Press START when ready.');});
  socket.on('dab_queueCancelled',()=>{inDabQueue=false;document.getElementById('dabQueueInfo').textContent='';document.getElementById('dabJoinBtn').style.display='inline-block';document.getElementById('dabStartBtn').style.display='none';document.getElementById('dabCancelBtn').style.display='none';});
  socket.on('dab_error',m=>toast(m,'err'));
  socket.on('dab_gameStart',d=>{dabRoomId=d.roomId;dabGridSize=d.gridSize;myPlayerIndex=d.yourIndex;myColor=d.yourColor;dabCurrentState={lines:{},boxes:{},currentPlayerIndex:d.currentPlayerIndex,scores:d.playerOrder};showDabGame(d);renderDabGrid(d.gridSize,d.playerOrder,d.currentPlayerIndex);document.getElementById('dabStatus').textContent='ACTIVE';inDabQueue=false;document.getElementById('dabJoinBtn').style.display='inline-block';document.getElementById('dabStartBtn').style.display='none';document.getElementById('dabCancelBtn').style.display='none';toast('Game! '+d.playerOrder.map(p=>p.username).join(' vs '));});
  socket.on('dab_gameUpdate',d=>{dabCurrentState=d;updateDabLines(d.lines);updateDabBoxes(d.boxes);updateDabScores(d.scores,d.currentPlayerIndex);});
  socket.on('dab_gameEnd',d=>setTimeout(()=>showDabResult(d),500));
  socket.on('dab_playerLeft',()=>{toast('A player left!','warn');dab_leaveGame();});
}

// NAVIGATION
function showGameSelect(){document.getElementById('gameSelect').style.display='flex';['tttPanel','bingoPanel','dabPanel'].forEach(id=>document.getElementById(id).classList.remove('active'));}
function loadTTT(){document.getElementById('gameSelect').style.display='none';document.getElementById('tttPanel').classList.add('active');}
function loadBingo(){document.getElementById('gameSelect').style.display='none';document.getElementById('bingoPanel').classList.add('active');}
function loadDAB(){document.getElementById('gameSelect').style.display='none';document.getElementById('dabPanel').classList.add('active');}
function openDrawer(){document.getElementById('drawer').classList.add('open');document.getElementById('drawerOverlay').classList.add('show');}
function closeDrawer(){document.getElementById('drawer').classList.remove('open');document.getElementById('drawerOverlay').classList.remove('show');}

// TTT
function ttt_findMatch(){socket.emit('ttt_findMatch');}
function ttt_cancel(){socket.emit('ttt_cancelSearch');}
function ttt_startTournament(){socket.emit('ttt_startTournament');}
function ttt_move(i){if(!tttMyTurn)return;if(document.querySelector(`.tttCell[data-i="${i}"]`).classList.contains('filled'))return;socket.emit('ttt_makeMove',{gameId:tttGameId,position:i});}
function ttt_updateBoard(s){document.getElementById('tttP1').textContent=s.player1Name;document.getElementById('tttP2').textContent=s.player2Name;s.board.forEach((sym,i)=>{const c=document.querySelector(`.tttCell[data-i="${i}"]`);if(sym){c.textContent=sym;c.classList.add('filled',sym);}});tttMyTurn=s.currentTurn===socket.id;const t=document.getElementById('tttTurn');t.textContent=tttMyTurn?'â–¶ YOUR TURN':"âŒ› OPPONENT'S TURN";t.style.color=tttMyTurn?'#00FF00':'#FFD700';}
function ttt_showBoard(){document.getElementById('tttLobby').style.display='none';document.getElementById('tttGame').classList.add('active');}
function ttt_resetCells(){document.querySelectorAll('.tttCell').forEach(c=>{c.textContent='';c.classList.remove('filled','X','O');});}
function ttt_backToLobby(){document.getElementById('tttGame').classList.remove('active');document.getElementById('tttLobby').style.display='flex';tttGameId=null;tttMyTurn=false;ttt_resetCells();}
function showTTTResult(result,gameId){tttGameId=gameId;const box=document.getElementById('resultBox');const title=document.getElementById('resultTitle');const sub=document.getElementById('resultSub');box.className='resultBox '+(result==='loss'?'loss':result==='draw'?'draw':'');if(result==='win'){title.textContent='YOU WIN!';sub.textContent='Excellent!';}else if(result==='loss'){title.textContent='YOU LOSE';sub.textContent='Better luck next time';}else{title.textContent='DRAW';sub.textContent='Well played!';}document.getElementById('resultScores').innerHTML='';document.getElementById('rematchBtn').style.display='inline-block';document.getElementById('rBackBtn').onclick=closeResult;document.getElementById('resultModal').classList.add('show');}
function closeResult(){document.getElementById('resultModal').classList.remove('show');ttt_backToLobby();}
function requestRematch(){if(tttGameId)socket.emit('ttt_rematch',tttGameId);document.getElementById('resultModal').classList.remove('show');toast('Rematch sent...');}

// BINGO
function bingo_join(){socket.emit('bingo_joinRoom');}
function bingo_leave(){socket.emit('bingo_leaveRoom');amHost=false;bingoActive=false;myCard=[];myMarked=[];document.getElementById('bingoLobby').style.display='flex';document.getElementById('bingoGame').classList.remove('active');document.getElementById('hostCtrl').style.display='none';document.getElementById('bingoStatus').textContent='LOBBY';showGameSelect();}
function showBingoGame(){document.getElementById('bingoLobby').style.display='none';document.getElementById('bingoGame').classList.add('active');}
function showBingoTab(tab){const tabs=document.querySelectorAll('.bingoTabs .tab');tabs.forEach((t,i)=>t.classList.toggle('active',i===(tab==='card'?0:1)));if(window.innerWidth<=700){document.getElementById('bingoLeft').style.display=tab==='card'?'flex':'none';document.getElementById('bingoRight').style.display=tab==='control'?'flex':'none';}}
function bingo_startGame(){socket.emit('bingo_startGame');}
function bingo_callNumber(){socket.emit('bingo_callNumber');}
function bingo_resetGame(){if(confirm('Reset game?'))socket.emit('bingo_resetGame');}
function bingo_claim(){socket.emit('bingo_claimBingo');}
function bingo_setAutoCall(v){socket.emit('bingo_setAutoCall',parseInt(v));}
function renderCard(){const c=document.getElementById('bingoCard');c.innerHTML='';myCard.forEach((num,i)=>{const el=document.createElement('div');el.className='bCell';if(num==='FREE'){el.textContent='FREE';el.classList.add('free','marked');}else{el.textContent=num;if(myMarked[i])el.classList.add('marked');}c.appendChild(el);});}
function renderCalledNum(num,isLatest){const c=document.getElementById('bCalledNums');document.querySelectorAll('.cnum-item.recent').forEach(el=>el.classList.remove('recent'));const span=document.createElement('span');span.className='cnum-item'+(isLatest?' recent':'');span.textContent=num;c.appendChild(span);c.scrollTop=c.scrollHeight;}
function clearCalledNums(){document.getElementById('bCalledNums').innerHTML='';document.getElementById('bCalledCount').textContent='0';}
function bingoLetter(n){if(n<=15)return'B';if(n<=30)return'I';if(n<=45)return'N';if(n<=60)return'G';return'O';}

// DOTS & BOXES
function dab_joinQueue(){const gs=parseInt(document.getElementById('dabGridSize').value);socket.emit('dab_joinQueue',gs);document.getElementById('dabGridSize').disabled=true;document.getElementById('dabMaxPlayers').disabled=true;}
function dab_startGame(){const gs=parseInt(document.getElementById('dabGridSize').value);const mp=parseInt(document.getElementById('dabMaxPlayers').value);socket.emit('dab_startWithQueue',{gridSize:gs,maxPlayers:mp});}
function dab_cancelQueue(){socket.emit('dab_cancelQueue');document.getElementById('dabGridSize').disabled=false;document.getElementById('dabMaxPlayers').disabled=false;document.getElementById('dabQueueInfo').textContent='';}
function dab_back(){if(inDabQueue)dab_cancelQueue();showGameSelect();}
function dab_leaveGame(){socket.emit('dab_leaveRoom');dabRoomId=null;myPlayerIndex=-1;document.getElementById('dabGame').classList.remove('active');document.getElementById('dabLobby').style.display='flex';document.getElementById('dabStatus').textContent='LOBBY';loadDAB();}
function showDabGame(d){document.getElementById('dabLobby').style.display='none';document.getElementById('dabGame').classList.add('active');updateDabScores(d.playerOrder,d.currentPlayerIndex);}
function renderDabGrid(gs,playerOrder,currentIdx){
  const grid=document.getElementById('dabGrid');grid.innerHTML='';
  const CS=getDabCellSize();
  grid.style.width=gs*CS+'px';grid.style.height=gs*CS+'px';
  for(let r=0;r<=gs;r++){for(let c=0;c<=gs;c++){const dot=document.createElement('div');dot.className='dabDotEl';const ds=Math.max(8,CS*0.13);dot.style.cssText=`left:${c*CS}px;top:${r*CS}px;width:${ds}px;height:${ds}px;`;grid.appendChild(dot);}}
  for(let r=0;r<=gs;r++){for(let c=0;c<gs;c++){const w=document.createElement('div');w.className='dabLineH';w.id=`dab_h_${r}_${c}`;const pad=CS*0.15;w.style.cssText=`left:${c*CS+pad}px;top:${r*CS}px;width:${CS-pad*2}px;height:${CS*0.22}px;`;w.onclick=()=>dab_clickLine(`h_${r}_${c}`);const inner=document.createElement('div');inner.className='dabLineInner';inner.style.cssText='width:100%;height:5px;';w.appendChild(inner);grid.appendChild(w);}}
  for(let r=0;r<gs;r++){for(let c=0;c<=gs;c++){const w=document.createElement('div');w.className='dabLineV';w.id=`dab_v_${r}_${c}`;const pad=CS*0.15;w.style.cssText=`left:${c*CS}px;top:${r*CS+pad}px;height:${CS-pad*2}px;width:${CS*0.22}px;`;w.onclick=()=>dab_clickLine(`v_${r}_${c}`);const inner=document.createElement('div');inner.className='dabLineInner';inner.style.cssText='height:100%;width:5px;';w.appendChild(inner);grid.appendChild(w);}}
  for(let r=0;r<gs;r++){for(let c=0;c<gs;c++){const box=document.createElement('div');box.className='dabBox';box.id=`dab_b_${r}_${c}`;const pad=CS*0.2;box.style.cssText=`left:${c*CS+pad}px;top:${r*CS+pad}px;width:${CS-pad*2}px;height:${CS-pad*2}px;font-size:${CS*0.26}px;`;grid.appendChild(box);}}
  updateDabScores(playerOrder,currentIdx);
}
function dab_clickLine(lineKey){if(!dabRoomId)return;if(dabCurrentState&&dabCurrentState.currentPlayerIndex!==myPlayerIndex){toast("Not your turn!",'err');return;}if(dabCurrentState&&dabCurrentState.lines&&dabCurrentState.lines[lineKey])return;socket.emit('dab_drawLine',{roomId:dabRoomId,lineKey});}
function updateDabLines(lines){if(!lines)return;Object.entries(lines).forEach(([key,data])=>{const el=document.getElementById('dab_'+key);if(!el)return;el.classList.add('drawn');el.onclick=null;const inner=el.querySelector('.dabLineInner');if(inner){inner.style.background=data.color;inner.style.opacity='1';}});}
function updateDabBoxes(boxes){if(!boxes)return;Object.entries(boxes).forEach(([key,data])=>{const el=document.getElementById('dab_'+key);if(!el||el.textContent)return;el.style.background=data.color+'28';el.style.border=`1px solid ${data.color}44`;el.textContent=data.username.charAt(0).toUpperCase();el.style.color=data.color;el.style.fontWeight='bold';el.style.display='flex';el.style.alignItems='center';el.style.justifyContent='center';});}
function updateDabScores(scores,currentIdx){
  const bar=document.getElementById('dabScoreBar');
  bar.innerHTML=scores.map((p,i)=>`<div class="dabScoreItem" style="color:${p.color};${i===currentIdx?'border:1px solid '+p.color+';padding:2px 8px;':''}">`+`<span class="dabColorDot" style="background:${p.color}"></span><span>${p.username}</span><span style="margin-left:4px;font-weight:bold;">${p.score}</span>${i===currentIdx?'<span style="margin-left:3px;">â–¶</span>':''}</div>`).join('');
  const isMyTurn=currentIdx===myPlayerIndex;
  const tb=document.getElementById('dabTurnBar');
  tb.textContent=isMyTurn?'â–¶ YOUR TURN â€” tap a line!':`âŒ› ${scores[currentIdx]?.username||'?'}'s turn...`;
  tb.style.color=isMyTurn?'#00FF00':'#FFD700';
}
function showDabResult(d){
  const box=document.getElementById('resultBox');const iWon=d.winners.includes(myUsername);
  box.className='resultBox '+(d.isDraw?'draw':(iWon?'':'loss'));
  document.getElementById('resultTitle').textContent=d.isDraw?'DRAW!':(iWon?'YOU WIN!':'YOU LOSE');
  document.getElementById('resultSub').textContent='Dots & Boxes result';
  document.getElementById('resultScores').innerHTML=d.scores.map((p,i)=>`<div class="resultScoreRow" style="color:${p.color}"><span>${['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'][i]||i+1+'.'} ${p.username}</span><span>${p.score} boxes</span></div>`).join('');
  document.getElementById('rematchBtn').style.display='none';
  document.getElementById('rBackBtn').onclick=()=>{document.getElementById('resultModal').classList.remove('show');document.getElementById('dabGame').classList.remove('active');document.getElementById('dabLobby').style.display='flex';dabRoomId=null;myPlayerIndex=-1;document.getElementById('dabStatus').textContent='LOBBY';document.getElementById('dabGridSize').disabled=false;document.getElementById('dabMaxPlayers').disabled=false;};
  document.getElementById('resultModal').classList.add('show');
}

// SIDEBAR
function updateSidebar(d){
  document.getElementById('onlineCount').textContent=d.players.length;
  document.getElementById('dOnlineCount').textContent=d.players.length;
  const ph=d.players.map(p=>`<div class="playerItem ${p.inGame?'busy':''}">&gt; ${p.username}${p.inGame?' <span style="color:#333;">[busy]</span>':''}</div>`).join('');
  ['sidePlayerList','dPlayerList'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=ph;});
  const rl=(ids,data)=>{const h=data.length?data.map((p,i)=>`<div class="lbItem"><span>${i+1}. ${p.username}</span><span class="pts">${p.points}p</span></div>`).join(''):'<div style="color:#333;font-size:10px;">No data</div>';ids.forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=h;});};
  rl(['sideTTTLb','dTTTLb'],d.tttLeaderboard||[]);
  rl(['sideBingoLb','dBingoLb'],d.bingoLeaderboard||[]);
  rl(['sideDABLb','dDABLb'],d.dabLeaderboard||[]);
  if(d.dabQueue>0)document.getElementById('dabQueueInfo').textContent=d.dabQueue+' player(s) in queue';
}

// CHAT
function toggleChat(){document.getElementById('chatWrap').classList.toggle('open');}
function sendChat(){const i=document.getElementById('chatIn');if(i.value.trim()&&socket){socket.emit('chatMessage',i.value.trim());i.value='';}}
function appendChat(un,msg){const m=document.getElementById('chatMsgs');m.innerHTML+=`<div class="chatMsg"><span class="cu">${un}:</span> ${msg}</div>`;m.scrollTop=m.scrollHeight;}

// TOAST
let toastT;
function toast(msg,type=''){const el=document.getElementById('toast');el.textContent=msg;el.className='show '+(type==='err'?'err':type==='warn'?'warn':'');clearTimeout(toastT);toastT=setTimeout(()=>el.className='',3500);}
</script>
</body>
</html>
HTMLEOF